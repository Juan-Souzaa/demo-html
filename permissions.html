<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Permissões - SEMEAR</title>
    <link rel="preconnect" href="https://fonts.bunny.net">
    <link href="https://fonts.bunny.net/css?family=inter:400,500,600,700&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="admin-layout">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">SE</div>
                    <div class="logo-text">
                        <h1>SEMEAR</h1>
                        <p>Sistema de Gestão Operacional</p>
                    </div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item"><a href="dashboard.html" class="nav-link"><i class="bi bi-bar-chart"></i> Dashboard</a></div>
                <div class="nav-item"><a href="planejamento.html" class="nav-link"><i class="bi bi-calendar3"></i> Planejamento</a></div>
                <div class="nav-item"><a href="obrigacoes.html" class="nav-link"><i class="bi bi-exclamation-triangle"></i> Obrigações</a></div>
                <div class="nav-item"><a href="reunioes.html" class="nav-link"><i class="bi bi-people"></i> Reuniões</a></div>
                <div class="nav-item"><a href="relatorios.html" class="nav-link"><i class="bi bi-file-text"></i> Relatórios</a></div>
                <div class="nav-item" id="nav-permissions-item"><a href="permissions.html" class="nav-link"><i class="bi bi-shield-lock"></i> Permissões</a></div>
            </nav>
        </aside>
        <main class="main-content">
            <header class="header">
                <button class="sidebar-toggle d-md-none" type="button" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
                <div class="header-title">
                    <h1>Permissões</h1>
                    <p>Gerenciamento de permissões e roles</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="abrirModalRole()"><i class="bi bi-plus-lg me-2"></i>Nova Role</button>
                    <button class="notification-btn" onclick="showNotifications()"><i class="bi bi-bell"></i><span class="notification-label" id="notification-count" style="display: none;">0</span></button>
                    <div class="dropdown">
                        <button class="profile-btn dropdown-toggle" type="button" id="profileDropdown" data-bs-toggle="dropdown"><i class="bi bi-person"></i></button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header" id="user-name">Usuário</h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person me-2"></i>Meu Perfil</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button type="button" class="dropdown-item text-danger" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>Sair</button></li>
                        </ul>
                    </div>
                </div>
            </header>
            <div class="content">
                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="metric-card">
                            <h3 class="metric-label mb-3">Roles</h3>
                            <div id="roles-list"></div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="metric-card">
                            <h3 class="metric-label mb-3">Usuários e Roles</h3>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Usuário</th>
                                            <th>E-mail</th>
                                            <th>Roles</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-roles-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal Role -->
    <div class="modal fade" id="roleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="roleModalTitle">Nova Role</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="roleForm">
                        <input type="hidden" id="roleId">
                        <div class="mb-3">
                            <label for="roleName" class="form-label">Nome da Role</label>
                            <input type="text" class="form-control" id="roleName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Permissões</label>
                            <div id="permissions-list" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarRole()">Salvar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Usuário Roles -->
    <div class="modal fade" id="userRolesModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gerenciar Roles do Usuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="userIdRoles">
                    <p><strong>Usuário:</strong> <span id="userNameRoles"></span></p>
                    <div class="mb-3">
                        <label class="form-label">Roles</label>
                        <div id="user-roles-checkboxes"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarUserRoles()">Salvar</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="app.js"></script>
    <script src="auth.js"></script>
    <script src="utils.js"></script>
    <script src="common.js"></script>
    <script>
        if (typeof DatabaseManager !== 'undefined' && !DatabaseManager.isInitialized()) { DatabaseManager.initialize(); DatabaseManager.seed(); }
        
        function carregarRoles() {
            const roles = DatabaseManager.getRoles();
            let html = '';
            roles.forEach(role => {
                html += '<div class="card mb-2"><div class="card-body"><h6 class="card-title">' + role.name + '</h6><p class="card-text small text-muted">' + (role.permissions ? role.permissions.length : 0) + ' permissões</p><div class="d-flex gap-1"><button class="btn btn-sm btn-outline-primary" onclick="editarRole(\'' + role.id + '\')"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="excluirRole(\'' + role.id + '\')"><i class="bi bi-trash"></i></button></div></div></div>';
            });
            document.getElementById('roles-list').innerHTML = html || '<p class="text-muted">Nenhuma role criada</p>';
        }
        
        function carregarUsuariosRoles() {
            const users = DatabaseManager.getUsers();
            console.log('Usuários encontrados:', users);
            let html = '';
            if (users && users.length > 0) {
                users.forEach(user => {
                    const userRoles = DatabaseManager.getUserRoles(user.id);
                    const rolesNames = userRoles.map(r => r.name).join(', ') || 'Nenhuma';
                    html += '<tr><td>' + user.name + '</td><td>' + user.email + '</td><td>' + rolesNames + '</td><td><button class="btn btn-sm btn-outline-primary" onclick="gerenciarUserRoles(\'' + user.id + '\', \'' + user.name.replace(/'/g, "\\'") + '\')"><i class="bi bi-gear"></i> Gerenciar</button></td></tr>';
                });
            } else {
                html = '<tr><td colspan="4" class="text-center py-4"><p class="text-muted">Nenhum usuário encontrado. Os usuários serão criados automaticamente ao fazer login ou registrar.</p></td></tr>';
            }
            document.getElementById('users-roles-tbody').innerHTML = html;
        }
        
        function abrirModalRole(roleId) {
            const modal = new bootstrap.Modal(document.getElementById('roleModal'));
            document.getElementById('roleForm').reset();
            document.getElementById('roleId').value = '';
            document.getElementById('roleModalTitle').textContent = 'Nova Role';
            
            const permissions = DatabaseManager.getPermissions();
            const grouped = {};
            permissions.forEach(perm => {
                if (!grouped[perm.group]) grouped[perm.group] = [];
                grouped[perm.group].push(perm);
            });
            
            let html = '';
            Object.keys(grouped).forEach(group => {
                html += '<div class="mb-3"><strong>' + group.charAt(0).toUpperCase() + group.slice(1) + '</strong><div class="ms-3">';
                grouped[group].forEach(perm => {
                    html += '<div class="form-check"><input class="form-check-input" type="checkbox" value="' + perm.id + '" id="perm_' + perm.id + '" name="permissions"><label class="form-check-label" for="perm_' + perm.id + '">' + perm.description + '</label></div>';
                });
                html += '</div></div>';
            });
            document.getElementById('permissions-list').innerHTML = html;
            
            if (roleId) {
                const role = DatabaseManager.getRoleById(roleId);
                if (role) {
                    document.getElementById('roleId').value = role.id;
                    document.getElementById('roleName').value = role.name;
                    document.getElementById('roleModalTitle').textContent = 'Editar Role';
                    if (role.permissions) {
                        role.permissions.forEach(permId => {
                            const checkbox = document.getElementById('perm_' + permId);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                }
            }
            
            modal.show();
        }
        
        function salvarRole() {
            const form = document.getElementById('roleForm');
            if (!form.checkValidity()) { form.classList.add('was-validated'); return; }
            
            const roleId = document.getElementById('roleId').value;
            const name = document.getElementById('roleName').value;
            const selectedPermissions = Array.from(document.querySelectorAll('#permissions-list input[type="checkbox"]:checked')).map(cb => cb.value);
            
            if (roleId) {
                DatabaseManager.updateRole(roleId, { name: name, permissions: selectedPermissions });
                Utils.showSuccess('Role atualizada com sucesso!');
            } else {
                DatabaseManager.createRole({ name: name, permissions: selectedPermissions });
                Utils.showSuccess('Role criada com sucesso!');
            }
            
            bootstrap.Modal.getInstance(document.getElementById('roleModal')).hide();
            carregarRoles();
            carregarUsuariosRoles();
        }
        
        function editarRole(roleId) {
            abrirModalRole(roleId);
        }
        
        function excluirRole(roleId) {
            Utils.confirm('Deseja realmente excluir esta role?', function() {
                DatabaseManager.deleteRole(roleId);
                Utils.showSuccess('Role excluída com sucesso!');
                carregarRoles();
                carregarUsuariosRoles();
            });
        }
        
        function gerenciarUserRoles(userId, userName) {
            const modal = new bootstrap.Modal(document.getElementById('userRolesModal'));
            document.getElementById('userIdRoles').value = userId;
            document.getElementById('userNameRoles').textContent = userName;
            
            const roles = DatabaseManager.getRoles();
            const userRoles = DatabaseManager.getUserRoles(userId);
            const userRoleIds = userRoles.map(r => r.id);
            
            let html = '';
            roles.forEach(role => {
                html += '<div class="form-check"><input class="form-check-input" type="checkbox" value="' + role.id + '" id="user_role_' + role.id + '" ' + (userRoleIds.includes(role.id) ? 'checked' : '') + '><label class="form-check-label" for="user_role_' + role.id + '">' + role.name + '</label></div>';
            });
            document.getElementById('user-roles-checkboxes').innerHTML = html || '<p class="text-muted">Nenhuma role disponível</p>';
            
            modal.show();
        }
        
        function salvarUserRoles() {
            const userId = document.getElementById('userIdRoles').value;
            const selectedRoles = Array.from(document.querySelectorAll('#user-roles-checkboxes input[type="checkbox"]:checked')).map(cb => cb.value);
            const currentRoles = DatabaseManager.getUserRoles(userId).map(r => r.id);
            
            // Remover roles não selecionadas
            currentRoles.forEach(roleId => {
                if (!selectedRoles.includes(roleId)) {
                    DatabaseManager.removeRoleFromUser(userId, roleId);
                }
            });
            
            // Adicionar novas roles
            selectedRoles.forEach(roleId => {
                if (!currentRoles.includes(roleId)) {
                    DatabaseManager.assignRoleToUser(userId, roleId);
                }
            });
            
            Utils.showSuccess('Roles do usuário atualizadas com sucesso!');
            bootstrap.Modal.getInstance(document.getElementById('userRolesModal')).hide();
            carregarUsuariosRoles();
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            if (!initCommon()) return;
            
            // Garantir que o banco está inicializado e tem dados
            if (typeof DatabaseManager !== 'undefined') {
                if (!DatabaseManager.isInitialized()) {
                    DatabaseManager.initialize();
                }
                DatabaseManager.seed();
            }
            
            carregarRoles();
            carregarUsuariosRoles();
        });
    </script>
</body>
</html>
