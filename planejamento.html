<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Planejamento - SEMEAR</title>
    <link rel="preconnect" href="https://fonts.bunny.net">
    <link href="https://fonts.bunny.net/css?family=inter:400,500,600,700&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="admin-layout">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">SE</div>
                    <div class="logo-text">
                        <h1>SEMEAR</h1>
                        <p>Sistema de Gestão Operacional</p>
                    </div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item"><a href="dashboard.html" class="nav-link"><i class="bi bi-bar-chart"></i> Dashboard</a></div>
                <div class="nav-item"><a href="planejamento.html" class="nav-link"><i class="bi bi-calendar3"></i> Planejamento</a></div>
                <div class="nav-item"><a href="obrigacoes.html" class="nav-link"><i class="bi bi-exclamation-triangle"></i> Obrigações</a></div>
                <div class="nav-item"><a href="reunioes.html" class="nav-link"><i class="bi bi-people"></i> Reuniões</a></div>
                <div class="nav-item"><a href="relatorios.html" class="nav-link"><i class="bi bi-file-text"></i> Relatórios</a></div>
                <div class="nav-item" id="nav-permissions-item" style="display: none;"><a href="permissions.html" class="nav-link"><i class="bi bi-shield-lock"></i> Permissões</a></div>
            </nav>
        </aside>
        <main class="main-content">
            <header class="header">
                <button class="sidebar-toggle d-md-none" type="button" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
                <div class="header-title">
                    <h1>Planejamento</h1>
                    <p>Centralização do planejamento e gestão das atividades</p>
                </div>
                <div class="header-actions">
                    <a href="planejamento-create.html" class="btn btn-primary"><i class="bi bi-plus-lg me-2"></i>Nova Atividade</a>
                    <button class="notification-btn" onclick="showNotifications()"><i class="bi bi-bell"></i><span class="notification-label" id="notification-count" style="display: none;">0</span></button>
                    <div class="dropdown">
                        <button class="profile-btn dropdown-toggle" type="button" id="profileDropdown" data-bs-toggle="dropdown"><i class="bi bi-person"></i></button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header" id="user-name">Usuário</h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person me-2"></i>Meu Perfil</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button type="button" class="dropdown-item text-danger" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>Sair</button></li>
                        </ul>
                    </div>
                </div>
            </header>
            <div class="content">
                <form id="filtroForm" class="row mb-4" onsubmit="event.preventDefault();">
                    <div class="col-md-6"><div class="input-group"><span class="input-group-text"><i class="bi bi-search"></i></span><input type="text" id="busca" class="form-control" placeholder="Buscar atividades..."></div></div>
                    <div class="col-md-2"><select id="filtroTipo" class="form-select"><option value="">Todos os tipos</option><option value="mutirao">Mutirão</option><option value="melhoria">Melhoria</option><option value="evento">Evento</option><option value="treinamento">Treinamento</option><option value="workshop">Workshop</option></select></div>
                    <div class="col-md-2"><select id="filtroStatus" class="form-select"><option value="">Todos os status</option><option value="planejada">Planejada</option><option value="em_andamento">Em Andamento</option><option value="concluida">Concluída</option><option value="cancelada">Cancelada</option></select></div>
                    <div class="col-md-2"><button type="submit" class="btn btn-outline-primary w-100"><i class="bi bi-funnel me-2"></i>Filtrar</button></div>
                </form>
                <div class="metric-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div><h3 class="metric-label mb-1" id="calendario-titulo">Agenda de Atividades</h3><p class="metric-description">Visualização mensal das atividades planejadas</p></div>
                        <div class="btn-group"><button class="btn btn-outline-secondary btn-sm" onclick="navegarMes(-1)"><i class="bi bi-chevron-left"></i></button><button class="btn btn-outline-secondary btn-sm" onclick="navegarMes(1)"><i class="bi bi-chevron-right"></i></button></div>
                    </div>
                    <div class="calendar-grid" id="calendario-container"></div>
                </div>
            </div>
        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="app.js"></script>
    <script src="auth.js"></script>
    <script src="utils.js"></script>
    <script src="common.js"></script>
    <script>
        if (typeof DatabaseManager !== 'undefined' && !DatabaseManager.isInitialized()) { DatabaseManager.initialize(); DatabaseManager.seed(); }
        let mesAtual = new Date().getMonth() + 1;
        let anoAtual = new Date().getFullYear();
        const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        
        function gerarCalendario(mes, ano) {
            const atividades = DatabaseManager.getAtividades();
            const atividadesMes = atividades.filter(a => {
                const dataInicio = new Date(a.data_inicio);
                return dataInicio.getMonth() + 1 === mes && dataInicio.getFullYear() === ano;
            });
            const atividadesPorDia = {};
            atividadesMes.forEach(a => {
                const dia = new Date(a.data_inicio).getDate();
                if (!atividadesPorDia[dia]) atividadesPorDia[dia] = [];
                atividadesPorDia[dia].push(a);
            });
            
            const primeiroDia = new Date(ano, mes - 1, 1);
            const ultimoDia = new Date(ano, mes, 0);
            const diaInicioSemana = primeiroDia.getDay();
            const diasNoMes = ultimoDia.getDate();
            
            let html = '<div class="calendar-header">';
            ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].forEach(dia => html += '<div class="calendar-day-header">' + dia + '</div>');
            html += '</div><div class="calendar-body">';
            
            for (let semana = 0; semana < 6; semana++) {
                html += '<div class="calendar-week">';
                for (let diaSemana = 0; diaSemana < 7; diaSemana++) {
                    const diaNumero = (semana * 7) + diaSemana - diaInicioSemana + 1;
                    const isDiaValido = diaNumero >= 1 && diaNumero <= diasNoMes;
                    const atividadesDoDia = isDiaValido && atividadesPorDia[diaNumero] ? atividadesPorDia[diaNumero] : [];
                    html += '<div class="calendar-day ' + (!isDiaValido ? 'empty' : '') + '">';
                    if (isDiaValido) {
                        html += '<div class="day-number">' + diaNumero + '</div>';
                        atividadesDoDia.forEach(atividade => {
                            const tipoClass = atividade.tipo || 'outro';
                            const tituloLimitado = Utils.limitText(atividade.titulo, 15);
                            html += '<a href="planejamento-show.html?id=' + atividade.id + '" class="activity-block ' + tipoClass + '" title="' + atividade.titulo + '">' + tituloLimitado + '</a>';
                        });
                    }
                    html += '</div>';
                }
                html += '</div>';
            }
            html += '</div>';
            document.getElementById('calendario-container').innerHTML = html;
            document.getElementById('calendario-titulo').textContent = 'Agenda de Atividades - ' + meses[mes - 1] + ' ' + ano;
        }
        
        function navegarMes(direcao) {
            mesAtual += direcao;
            if (mesAtual > 12) { mesAtual = 1; anoAtual++; }
            if (mesAtual < 1) { mesAtual = 12; anoAtual--; }
            gerarCalendario(mesAtual, anoAtual);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            if (!initCommon()) return;
            gerarCalendario(mesAtual, anoAtual);
        });
    </script>
</body>
</html>

